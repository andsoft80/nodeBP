<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="suite.js" type="text/javascript"></script>
        <link href="suite.css" rel="stylesheet" type="text/css"/>
        <script src="jquery-3.4.1.min.js" type="text/javascript"></script>
        <link href="index.css" rel="stylesheet" type="text/css"/>
        <style>
            html, body {height:100%;}
            .dhx_sample-container {
                height: 100%;
            }
        </style>
    </head>
    <body onload = "init()">

        <section class="dhx_sample-container">
            <div class="dhx_sample-container__widget" id="layout"></div>

        </section>
        <script>
            function init(){
                loadTree();
            }
            var layout = new dhx.Layout("layout", {
                css: "dhx_layout-cell--bordered",
                rows: [{
                        id: "toolbar",
                        header: "BP 1.0 Configurator",
                        //collapsable: true,
                        css: "dhx_layout-cell--border_bottom",
                        gravity: false,
                        height: "80px"
                    },
                    {
                        cols: [{
                                id: "sidebar",
                                header: "Menu",
                                collapsable: true,
                                gravity: false,
                                css: "dhx_layout-cell--border_right",
                                resizable: true,
                                width: "200px",
                                rows: [
                                    {
                                        id: "s_toolbar"
                                    },
                                    {
                                        id: "s_tree"
                                    },
                                ]
                            },
                            {
                                resizable: true,
                                rows: [{
                                        id: "content",
                                        css: "",
                                        header: "Workplace",

                                    }, ]
                            },
                            {
                                id: "rightbar",
                                header: "Settings",
                                collapsable: true,
                                gravity: false,
                                css: "dhx_layout-cell--border_left",
                                resizable: true,
                                width: "200px"
                            },
                        ]
                    },
                    {
                        id: "footer",
                        //header: "Footer",
                        //collapsable: true,
                        css: "dhx_layout-cell--border_top",
                        gravity: false,
                        height: "40px",

                    }
                ]
            });

//-->Sidebar ToolBar/////////////////////////////////////////////////////////////
            var toolbar = new dhx.Toolbar(null);
            var data = [
                {
                    type: "button",
                    icon: "dxi-plus",
                    size: "small",
                    value: "",
                    id: 'add'
                },

                {
                    type: "button",
                    icon: "dxi-vault",
                    size: "small",
                    value: "",
                    id: 'save'
                },
                {
                    type: "button",
                    icon: "dxi-delete",
                    size: "small",
                    value: "",
                    id: 'delete'
                }
            ];
            toolbar.data.parse(data);
            layout.cell('s_toolbar').attach(toolbar);

            toolbar.events.on("Click", function (id, e) {
                var selCurrTreeItem = tree.selection.getId();

                if (selCurrTreeItem !== undefined) {
                    var selCurrTreeItemName = tree.selection.getItem().value;
                    //alert(JSON.stringify(selCurrTreeItemName));
                    var rows = [
                        {
                            type: "text",
                            //label: "text",
                            //labelInline: true,
                            value: "Create new of " + selCurrTreeItemName
                        },
                        {
                            id: "name",
                            type: "input",
                            label: "Name",
                            icon: "dxi-magnify",
                            placeholder: "Object name"
                        },
                        {
                            cols: [
                                {
                                    type: "button",
                                    value: "Save",
                                    size: "medium",
                                    view: "flat",
                                    color: "primary",
                                    id: "saveObject"
                                },
                                {
                                    type: "button",
                                    value: "Cancel",
                                    size: "medium",
                                    view: "flat",
                                    color: "primary",
                                    id: "cancel"
                                }
                            ]}

                    ];
                    var form = new dhx.Form(null, {rows});
                    layout.cell('rightbar').attach(form);
                    form.events.on("ButtonClick", function (id, e) {
                        if (id === "saveObject") {
                            if (form.getValue().name) {
                                var objectModel = {};
                                objectModel.objectType = tree.selection.getItem().id;
                                objectModel.name = form.getValue().name;

                                saveObject(objectModel, form);
                            } else {
                                alert("Input name of object!");
                            }
                        }
                        if (id === "cancel") {
                            // layout.cell('rightbar').detach(form);
                            form.destructor();
                        }
                    });
                }
            });

//<--Sidebar ToolBar/////////////////////////////////////////////////////////////
            function saveObject(objectModel, callform) {
                $.ajax({
                    type: "post",
                    //async: false,
                    url: "/metadata",
                    //headers: {"Access-Control-Allow-Origin": "*"},
                    data: objectModel,
                    success: function (data) {
                        alert('Saved!');
                        callform.destructor();
                        loadTree(data.doc._id);
                        
                    }
                });
            }
            ;
            function getObject() {
                $.ajax({
                    type: "get",
                    //async: false,
                    url: "/metadata",
                    //headers: {"Access-Control-Allow-Origin": "*"},

                    success: function (data) {


                    }
                });
            }
            ;
//-->Sidebar Tree/////////////////////////////////////////////////////////////
            function loadTree(id) {
                var url = id ? '/metadata/' + id : '/metadata';
                
                $.ajax({
                    type: "get",
                    //async: false,
                    url: url,
                    //headers: {"Access-Control-Allow-Origin": "*"},

                    success: function (data) {
                        if (id) {//single object
                            if (tree.data.getItem(id)) {//exist
                                //refresh item
                            } else {//new
                                
                                objType = data.objectType;
                                
                                
                                tree.data.add({value:data.name, id:id},0,objType);
                            }
                        } else {//all tree
                            for(i=0;i<data.length;i++){
                                var object = data[i];
                                tree.data.add({value:object.name, id:object._id},0,object.objectType);
                            }

                        }

                    }
                });
            }
            var tree = new dhx.Tree(null, {keyNavigation: true});
            tree.data.add({
                type: "button",
                icon: "dxi-plus",
                value: "Directories",
                id: 'dir'
            }, 1);
            tree.data.add({
                type: "button",
                icon: "dxi-plus",
                value: "Documents",
                id: 'doc'
            }, 2);
            tree.data.add({
                type: "button",
                icon: "dxi-plus",
                value: "Settings",
                id: 'setting'
            }, 3);
            tree.data.add({
                type: "button",
                icon: "dxi-plus",
                value: "Enums",
                id: 'enum'
            }, 4);
            tree.data.add({
                type: "button",
                icon: "dxi-plus",
                value: "Reports",
                id: 'report'
            }, 5);
            tree.data.add({
                type: "button",
                icon: "dxi-plus",
                value: "Transactions",
                id: 'trx'
            }, 6);
            layout.cell('s_tree').attach(tree);

//-->Sidebar Tree/////////////////////////////////////////////////////////////            
        </script>


    </body>
</html>
