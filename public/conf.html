<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="suite.js" type="text/javascript"></script>
        <link href="suite.css" rel="stylesheet" type="text/css"/>
        <script src="jquery-3.4.1.min.js" type="text/javascript"></script>
        <link href="index.css" rel="stylesheet" type="text/css"/>
        <script src="global.js" type="text/javascript"></script>
        <style>
            html, body {height:100%;}
            .dhx_sample-container {
                height: 100%;
            }
            .dn{
                display: none;

            }
            .oa{
                overflow: auto;
            } 
        </style>
    </head>
    <body onload = "init()">

        <section class="dhx_sample-container">
            <div class="dhx_sample-container__widget" id="layout"></div>

        </section>
        <script>
            function init() {
                loadTree();
            }
            var headerHeight = '120';
            var bottomHeight = '40';
            var workSpaceHeight = $(window).height() - headerHeight - 200;
            var tabsWorkplace = {};
            var tabsLayouts = {};


//            window.addEventListener('resize', function (event) {
//                workSpaceHeight = $(window).height() - headerHeight - 200;
//                alert(workSpaceHeight);
//                $("['aria-labelledby'='tab-content-main']").height(workSpaceHeight + 50);
//            });
            $(window).resize(function () {
//                workSpaceHeight = $(window).height() - headerHeight - 200;
//
//                $("[aria-labelledby='tab-content-main']").css("flex-basis", workSpaceHeight + 50);
//                $("[aria-labelledby='tab-content-main']").css("height", workSpaceHeight + 50);

            });


            var layout = new dhx.Layout("layout", {
                css: "dhx_layout-cell--bordered",
                rows: [{
                        id: "toolbar",
                        header: "BP 1.0 Configurator",
                        //collapsable: true,
                        css: "dhx_layout-cell--border_bottom",
                        gravity: false,
                        height: headerHeight + 'px'
                    },
                    {
                        cols: [{
                                id: "sidebar",
                                header: "Menu",
                                collapsable: true,
                                gravity: false,
                                css: "dhx_layout-cell--border_right",
                                resizable: true,
                                width: "200px",
                                rows: [
                                    {
                                        id: "s_toolbar"
                                    },
                                    {
                                        id: "s_tree"
                                    },
                                ]
                            },
                            {
                                resizable: true,
                                //rows: [{
                                id: "content",
                                css: "",
                                header: "Workplace",
                                width: "600px"

                                        //}, ]
                            },
                            {
                                id: "rightbar",
                                header: "Settings",
                                collapsable: true,
                                gravity: false,
                                css: "dhx_layout-cell--border_left",
                                resizable: true,
                                width: "200px"
                            },
                        ]
                    },
                    {
                        id: "footer",
                        //header: "Footer",
                        //collapsable: true,
                        css: "dhx_layout-cell--border_top",
                        gravity: false,
                        height: bottomHeight + 'px',

                    }
                ]
            });

//-->Main ToolBar////////////////////////////////////////////////////////////////
            var toolbarMain = new dhx.Toolbar(null);
            var data = [
                {
                    type: "button",
                    icon: "dxi-chevron-right",
                    size: "small",
                    value: "",
                    id: 'start'
                },
                {
                    type: "button",
                    icon: "dxi-vault",
                    size: "small",
                    value: "",
                    id: 'save'
                }
            ]
            toolbarMain.data.parse(data);
            layout.cell('toolbar').attach(toolbarMain);
            toolbarMain.events.on("Click", function (id, e) {
                if (id === 'save') {



                }
                if (id === 'start') {

                    $.ajax({
                        type: "post",
                        //async: false,
                        url: "/build",
                        //headers: {"Access-Control-Allow-Origin": "*"},

                        success: function (data) {
                            alert("Build done!");

                        }
                    });
                }
            });

//<--Main ToolBar////////////////////////////////////////////////////////////////
//-->Sidebar ToolBar/////////////////////////////////////////////////////////////
            var toolbar = new dhx.Toolbar(null);
            var data = [
                {
                    type: "button",
                    icon: "dxi-plus",
                    size: "small",
                    value: "",
                    id: 'add'
                },

                {
                    type: "button",
                    icon: "dxi-vault",
                    size: "small",
                    value: "",
                    id: 'save'
                },
                {
                    type: "button",
                    icon: "dxi-delete",
                    size: "small",
                    value: "",
                    id: 'delete'
                }
            ];
            toolbar.data.parse(data);
            layout.cell('s_toolbar').attach(toolbar);

            toolbar.events.on("Click", function (id, e) {
                var selCurrTreeItem = tree.selection.getId();

                if (selCurrTreeItem !== undefined) {
                    var selCurrTreeItemName = tree.selection.getItem().value;
                    //alert(JSON.stringify(selCurrTreeItemName));
                    var rows = [
                        {
                            type: "text",
                            //label: "text",
                            //labelInline: true,
                            value: "Create new of " + selCurrTreeItemName
                        },
                        {
                            id: "name",
                            type: "input",
                            label: "Name",
                            icon: "dxi-magnify",
                            placeholder: "Object name"
                        },
                        {
                            cols: [
                                {
                                    type: "button",
                                    value: "Save",
                                    size: "medium",
                                    view: "flat",
                                    color: "primary",
                                    id: "saveObject"
                                },
                                {
                                    type: "button",
                                    value: "Cancel",
                                    size: "medium",
                                    view: "flat",
                                    color: "primary",
                                    id: "cancel"
                                }
                            ]}

                    ];
                    var form = new dhx.Form(null, {rows});
                    layout.cell('rightbar').attach(form);
                    form.events.on("ButtonClick", function (id, e) {
                        if (id === "saveObject") {
                            if (form.getValue().name) {
                                var objectModel = {};
                                objectModel.objectType = tree.selection.getItem().id;
                                objectModel.name = form.getValue().name;

                                saveObject(objectModel, form);
                            } else {
                                alert("Input name of object!");
                            }
                        }
                        if (id === "cancel") {
                            // layout.cell('rightbar').detach(form);
                            form.destructor();
                        }
                    });
                }
            });

//<--Sidebar ToolBar/////////////////////////////////////////////////////////////
            function saveObject(objectModel, callform) {
                $.ajax({
                    type: "post",
                    //async: false,
                    url: "/metadata",
                    //headers: {"Access-Control-Allow-Origin": "*"},
                    data: objectModel,
                    success: function (data) {
                        alert('Saved!');
                        callform.destructor();
                        loadTree(data.doc._id);

                    }
                });
            }
            ;
            function getObject() {
                $.ajax({
                    type: "get",
                    //async: false,
                    url: "/metadata",
                    //headers: {"Access-Control-Allow-Origin": "*"},

                    success: function (data) {


                    }
                });
            }
            ;
//-->Sidebar Tree/////////////////////////////////////////////////////////////
            function loadTree(id) {
                var url = id ? '/metadata/' + id : '/metadata';

                $.ajax({
                    type: "get",
                    //async: false,
                    url: url,
                    //headers: {"Access-Control-Allow-Origin": "*"},

                    success: function (data) {
                        if (id) {//single object
                            if (tree.data.getItem(id)) {//exist
                                //refresh item
                            } else {//new

                                objType = data.objectType;


                                tree.data.add({value: data.name, id: id}, 0, objType);
                            }
                        } else {//all tree
                            for (i = 0; i < data.length; i++) {
                                var object = data[i];
                                tree.data.add({value: object.name, id: object._id}, 0, object.objectType);
                            }

                        }

                    }
                });
            }
            var tree = new dhx.Tree(null, {keyNavigation: true});
            tree.data.add({
                type: "button",
                icon: "dxi-plus",
                value: "Directories",
                id: 'dir'
            }, 1);
            tree.data.add({
                type: "button",
                icon: "dxi-plus",
                value: "Documents",
                id: 'doc'
            }, 2);
            tree.data.add({
                type: "button",
                icon: "dxi-plus",
                value: "Settings",
                id: 'setting'
            }, 3);
            tree.data.add({
                type: "button",
                icon: "dxi-plus",
                value: "Enums",
                id: 'enum'
            }, 4);
            tree.data.add({
                type: "button",
                icon: "dxi-plus",
                value: "Reports",
                id: 'report'
            }, 5);
            tree.data.add({
                type: "button",
                icon: "dxi-plus",
                value: "Transactions",
                id: 'trx'
            }, 6);

            layout.cell('s_tree').attach(tree);

            tree.events.on("itemClick", function (id, e) {
                if (tree.data.getParent(id).indexOf("ROOT") == -1) {//second level and more...

                    if (!tabsWorkplace[tree.data.getItem(id).value]) {//no Tab

                        tabbar.addCell({
                            tab: tree.data.getItem(id).value,
                            id: tree.data.getItem(id).value

                        }, 0);


                        tabsWorkplace[tree.data.getItem(id).value] = true;
                        tabbar.setActive(tree.data.getItem(id).value);
//                        var c = tabbar.cell(tree.data.getItem(id).value);
//                        c.attach(tree);
                        //alert(tabbar.length);
                        createObjectConfigurator(tree.data.getItem(id).value);


                    } else {//exist Tab

                        tabbar.setActive(tree.data.getItem(id).value)


                    }
                }
            });

//<--Sidebar Tree/////////////////////////////////////////////////////////////
//--> ObjectConfigurator//////////////////////////////////////////////////////
            function createObjectConfigurator(id) {


                var layoutObjConf = new dhx.Layout(null, {rows: [{id: "main"}]});




                var tabbarObjConf = new dhx.Tabbar(null, {
                    closeButtons: false,
                    mode: "top",
                    tabWidth: 100,
                    views: [
                        {tab: "Fields", id: "fields"},
                        {tab: "Forms", id: "forms"},
                        {tab: "Code", id: "code"}
                    ]

                });

                tabsLayouts[id] = layoutObjConf;
                tabbar.cell(id).attach(layoutObjConf);

                var rows = [
                    {
                        id: "name",
                        type: "input",
                        label: "Name",
                        icon: "dxi-magnify",
                        //labelInline: true,
                        placeholder: "John Doe"
                    },

                    {
                        id: "email",
                        type: "input",
                        label: "Email",
                        //labelInline: true,
                        placeholder: "jd@mail.name"
                    },
                    {
                        type: "checkbox",
                        label: "I agree",
                        name: "agree",
                        labelInline: true,
                        id: "agree",
                        value: "checkboxvalue",
                    },
                    {
                        type: "button",
                        value: "Send",
                        size: "medium",
                        view: "flat",
                        color: "primary"
                    }
                ]
                var form = new dhx.Form("form_container", {cellCss:"oa", rows});
                var layoutObjConfContent = new dhx.Layout(null, {rows: [{id: "mainContent"}]});
                layoutObjConf.cell("main").attach(tabbarObjConf);
                tabbarObjConf.cell('fields').attach(layoutObjConfContent);
                layoutObjConfContent.cell('mainContent').attach(form);
            }
//<--ObjectConfigurator//////////////////////////////////////////////////////
//-->TabBar Workplace///////////////////////////////////////////////////////////

            var tabbar = new dhx.Tabbar(null, {
                closeButtons: true,
                views: [
                    {tab: "left", tabCss: "dn"}


                ]

            });



            tabbar.events.on("Close", function (id) {
                tabsWorkplace[id] = false;
                tabsLayouts[id] = null;
                tabbar.setActive(tabbar.setActive(tabbar.getId(0)));

            });
            layout.cell('content').attach(tabbar);
            tabbar.events.on("Change", function (activeId, prevId) {


            });
//<--TabBar Workplace//////////////////////////////////////////////////////////  
        </script>


    </body>
</html>
