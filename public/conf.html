<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="suite.js" type="text/javascript"></script>
        <link href="suite.css" rel="stylesheet" type="text/css"/>
        <script src="jquery-3.4.1.min.js" type="text/javascript"></script>
        <link href="index.css" rel="stylesheet" type="text/css"/>
        <script src="global.js" type="text/javascript"></script>
        <!--        <script src="codebase/dhtmlx.js" type="text/javascript"></script>
                <link href="codebase/dhtmlx.css" rel="stylesheet" type="text/css"/>-->

        <style>
            html, body {height:100%;}
            .dhx_sample-container {
                height: 100%;
            }
            .dn{
                display: none;

            }
            .oa{
                overflow: auto;
            } 
        </style>
        <style>
            .ht .dhx_input {
                height: 25px;
            }
            .baseheight{
                height: 500px;
            }
        </style>
    </head>
    <body onload = "init()">

        <section class="dhx_sample-container">
            <div class="dhx_sample-container__widget" id="layout"></div>

        </section>
        <script>
            function init() {
                loadTree();
            }
            var headerHeight = '120';
            var bottomHeight = '40';
            var workSpaceHeight = $(window).height() - headerHeight - 200;
            var tabsWorkplace = {};
            var tabsLayouts = {};


//            window.addEventListener('resize', function (event) {
//                workSpaceHeight = $(window).height() - headerHeight - 200;
//                alert(workSpaceHeight);
//                $("['aria-labelledby'='tab-content-main']").height(workSpaceHeight + 50);
//            });
            $(window).resize(function () {
//                workSpaceHeight = $(window).height() - headerHeight - 200;
//
//                $("[aria-labelledby='tab-content-main']").css("flex-basis", workSpaceHeight + 50);
//                $("[aria-labelledby='tab-content-main']").css("height", workSpaceHeight + 50);

            });
            function createSmallToolBar() {
                var toolbar = new dhx.Toolbar(null);
                var data = [
                    {
                        type: "button",
                        icon: "dxi-plus",
                        size: "small",
                        value: "",
                        id: 'add'
                    },

                    {
                        type: "button",
                        icon: "dxi-vault",
                        size: "small",
                        value: "",
                        id: 'save'
                    },
                    {
                        type: "button",
                        icon: "dxi-delete",
                        size: "small",
                        value: "",
                        id: 'delete'
                    }
                ];
                toolbar.data.parse(data);
                return toolbar;
            }


            var layout = new dhx.Layout("layout", {
                css: "dhx_layout-cell--bordered",
                rows: [{
                        id: "toolbar",
                        header: "BP 1.0 Configurator",
                        //collapsable: true,
                        css: "dhx_layout-cell--border_bottom",
                        gravity: false,
                        //height: headerHeight + 'px'
                    },
                    {
                        cols: [{
                                id: "sidebar",
                                header: "Menu",
                                collapsable: true,
                                gravity: false,
                                css: "dhx_layout-cell--border_right",
                                resizable: true,
                                width: "200px",
                                rows: [
                                    {
                                        id: "s_toolbar"
                                    },
                                    {
                                        id: "s_tree"
                                    },
                                ]
                            },
                            {
                                resizable: true,
                                //gravity: false,
                                //rows: [{
                                id: "content",
                                css: "",
                                header: "Workplace",
                                width: "600px"

                                        //}, ]
                            },
                            {
                                id: "rightbar",
                                header: "Settings",
                                collapsable: true,
                                gravity: false,
                                css: "dhx_layout-cell--border_left",
                                resizable: true,
                                width: "300px",
                                rows: [
                                    {
                                        id: "r_props"
                                    },
                                    {
                                        id: "r_props2"
                                    },
                                    {
                                        id: "r_actions"
                                    },
                                ]
                            },
                        ]
                    },
                    {
                        id: "footer",
                        //header: "Footer",
                        //collapsable: true,
                        css: "dhx_layout-cell--border_top",
                        gravity: false,
                        height: bottomHeight + 'px',

                    }
                ]
            });

//-->Main ToolBar////////////////////////////////////////////////////////////////
            var toolbarMain = new dhx.Toolbar(null);
            var data = [
                {
                    type: "button",
                    icon: "dxi-chevron-right",
                    size: "small",
                    value: "",
                    id: 'start'
                },
                {
                    type: "button",
                    icon: "dxi-vault",
                    size: "small",
                    value: "",
                    id: 'save'
                }
            ]
            toolbarMain.data.parse(data);
            layout.cell('toolbar').attach(toolbarMain);
            toolbarMain.events.on("Click", function (id, e) {
                if (id === 'save') {



                }
                if (id === 'start') {

                    $.ajax({
                        type: "post",
                        //async: false,
                        url: "/build",
                        //headers: {"Access-Control-Allow-Origin": "*"},

                        success: function (data) {
                            alert("Build done!");

                        }
                    });
                }
            });

//<--Main ToolBar////////////////////////////////////////////////////////////////
//-->Sidebar ToolBar/////////////////////////////////////////////////////////////

            var toolbar = createSmallToolBar();
            layout.cell('s_toolbar').attach(toolbar);

            toolbar.events.on("Click", function (id, e) {
                var selCurrTreeItem = tree.selection.getId();

                if (selCurrTreeItem !== undefined) {
                    var selCurrTreeItemName = tree.selection.getItem().value;
                    //alert(JSON.stringify(selCurrTreeItemName));
                    var rows = [
                        {
                            type: "text",
                            //label: "text",
                            //labelInline: true,
                            value: "Create new of " + selCurrTreeItemName
                        },
                        {
                            id: "name",
                            type: "input",
                            label: "Name",
                            icon: "dxi-magnify",
                            placeholder: "Object name"
                        },
                        {
                            cols: [
                                {
                                    type: "button",
                                    value: "Save",
                                    size: "medium",
                                    view: "flat",
                                    color: "primary",
                                    id: "saveObject"
                                },
                                {
                                    type: "button",
                                    value: "Cancel",
                                    size: "medium",
                                    view: "flat",
                                    color: "primary",
                                    id: "cancel"
                                }
                            ]}

                    ];
                    var form = new dhx.Form(null, {rows});
                    layout.cell('r_props').attach(form);
                    layout.cell('r_props2').attachHTML("<div></div>");
                    form.events.on("ButtonClick", function (id, e) {
                        if (id === "saveObject") {
                            if (form.getValue().name) {
                                var objectModel = {};
                                objectModel.objectType = tree.selection.getItem().id;
                                objectModel.name = form.getValue().name;

                                saveObject(objectModel, form);
                            } else {
                                alert("Input name of object!");
                            }
                        }
                        if (id === "cancel") {
                            // layout.cell('rightbar').detach(form);
                            form.destructor();
                        }
                    });
                }
            });

//<--Sidebar ToolBar/////////////////////////////////////////////////////////////
            function saveObject(objectModel, callform) {
                $.ajax({
                    type: "post",
                    //async: false,
                    url: "/metadata",
                    //headers: {"Access-Control-Allow-Origin": "*"},
                    data: objectModel,
                    success: function (data) {
                        if (data.status === 200) {
                            alert('Saved!');
                            callform.destructor();
                            loadTree(data.doc._id);
                        } else {
                            alert(data);
                        }

                    }
                });
            }
            ;
            function getObject(id, promise) {

                $.ajax({
                    type: "get",
                    async: false,
                    url: "/metadata/" + id,
                    //headers: {"Access-Control-Allow-Origin": "*"},

                    success: function (data) {
                        promise(data);


                    }
                });

            }
            ;
            function updateObject(objectModel, callform, promise) {
                objectModel.__v++;
                objectModel.changed = true;
                $.ajax({
                    type: "put",
                    //async: false,
                    url: "/metadata",
                    //headers: {"Access-Control-Allow-Origin": "*"},
                    data: JSON.stringify(objectModel),
                    //data: objectModel,
//                    dataType: 'json',
                    contentType: 'application/json',
                    success: function (data) {
                        promise(data);
                        if (data.status === 200) {
                            //alert('Updated!');
                            callform.destructor();
                        } else {
                            alert(data);
                        }


                    }
                });
            }
            ;

//-->Sidebar Tree/////////////////////////////////////////////////////////////
            function loadTree(id) {
                var url = id ? '/metadata/' + id : '/metadata';

                $.ajax({
                    type: "get",
                    //async: false,
                    url: url,
                    //headers: {"Access-Control-Allow-Origin": "*"},

                    success: function (data) {
                        if (id) {//single object
                            if (tree.data.getItem(id)) {//exist
                                //refresh item
                            } else {//new

                                objType = data.objectType;


                                tree.data.add({value: data.name, id: id}, 0, objType);
                            }
                        } else {//all tree
                            for (i = 0; i < data.length; i++) {
                                var object = data[i];
                                tree.data.add({value: object.name, id: object._id}, 0, object.objectType);
                            }

                        }

                    }
                });
            }
            var tree = new dhx.Tree(null, {keyNavigation: true});
            tree.data.add({
                type: "button",
                icon: "dxi-plus",
                value: "Directories",
                id: 'dir'
            }, 1);
            tree.data.add({
                type: "button",
                icon: "dxi-plus",
                value: "Documents",
                id: 'doc'
            }, 2);
            tree.data.add({
                type: "button",
                icon: "dxi-plus",
                value: "Settings",
                id: 'setting'
            }, 3);
            tree.data.add({
                type: "button",
                icon: "dxi-plus",
                value: "Enums",
                id: 'enum'
            }, 4);
            tree.data.add({
                type: "button",
                icon: "dxi-plus",
                value: "Reports",
                id: 'report'
            }, 5);
            tree.data.add({
                type: "button",
                icon: "dxi-plus",
                value: "Transactions",
                id: 'trx'
            }, 6);

            layout.cell('s_tree').attach(tree);

            tree.events.on("itemClick", function (id, e) {
                if (tree.data.getParent(id).indexOf("ROOT") == -1) {//second level and more...

                    if (!tabsWorkplace[id]) {//no Tab

                        tabbar.addCell({
                            tab: tree.data.getItem(id).value,
                            //id: tree.data.getItem(id).value
                            id: id

                        }, 0);


                        //tabsWorkplace[tree.data.getItem(id).value] = true;
                        tabsWorkplace[id] = true;
                        //tabbar.setActive(tree.data.getItem(id).value);
                        tabbar.setActive(id);
//                        var c = tabbar.cell(tree.data.getItem(id).value);
//                        c.attach(tree);
                        //alert(tabbar.length);
                        //createObjectConfigurator(tree.data.getItem(id).value);
                        createObjectConfigurator(id);


                    } else {//exist Tab

                        //tabbar.setActive(tree.data.getItem(id).value)
                        tabbar.setActive(id);


                    }
                }
            });

//<--Sidebar Tree/////////////////////////////////////////////////////////////
//--> ObjectConfigurator//////////////////////////////////////////////////////
            function createObjectConfigurator(id) {

                var tableParts = null;
                var forms = null;
                var code = null;

                var layoutObjConf = new dhx.Layout(null, {rows: [{id: "main"}]});




                var tabbarObjConf = new dhx.Tabbar(null, {
                    closeButtons: false,
                    mode: "top",
                    tabWidth: 100,
                    views: [
                        {tab: "Fields", id: "fields"},
                        {tab: "Forms", id: "forms"},
                        {tab: "Code", id: "code"}
                    ]

                });

                tabsLayouts[id] = layoutObjConf;
                tabbar.cell(id).attach(layoutObjConf);


                layoutObjConf.cell("main").attach(tabbarObjConf);


                $.ajax({
                    type: "get",
                    //async: false,
                    url: '/metadata/' + id,
                    //headers: {"Access-Control-Allow-Origin": "*"},

                    success: function (data) {
                        createFieldTab(tabbarObjConf, data);

                    }
                });

            }

            function loadFielsdList(list, objId) {
                getObject(objId, function (obj) {
                    fields = obj.fields;
                    var data = [];
                    for (var i = 0; i < fields.length; i++) {
                        var dataElement = {};
                        dataElement.value = fields[i];
                        dataElement.id = fields[i].id;
                        data.push(dataElement);
                    }
                    list.data.parse(data);
                });
            }
            function loadFielsdListForm(list, objId) {
                getObject(objId, function (obj) {
                    fields = obj.listForm;
                    var data = [];
                    for (var i = 0; i < fields.length; i++) {
                        var dataElement = {};
                        dataElement.value = fields[i];
                        dataElement.id = fields[i].id;
                        data.push(dataElement);
                    }
                    list.data.parse(data);
                });
            }
            function getFields(list) {
                var fields = [];
                var items = list.data.serialize();

                for (var i = 0; i < items.length; i++) {
                    fields.push(items[i].value);
                }
                return fields;
            }
            function saveFields(objId, list) {
                var fields = getFields(list);

                getObject(objId, function (obj) {
                    obj.fields = fields;
                    updateObject(obj, null, function (result) {

                    });

                });

            }
            function saveFieldsListForm(objId, list) {
                var fields = getFields(list);

                getObject(objId, function (obj) {
                    obj.listForm = fields;
                    updateObject(obj, null, function (result) {

                    });

                });

            }
            function editField(data, list, field) {

                var rows = [
                    {
                        type: "text",
                        //label: "text",
                        //labelInline: true,
                        value: "Create new field"
                    },
                    {
                        id: "fieldId",
                        type: "input",
                        label: "Id",
                        placeholder: "Id"
                    },
                    {
                        id: "alias",
                        type: "input",
                        label: "Alias",
                        placeholder: "Alias"
                    },
                    {
                        id: "helpText",
                        type: "input",
                        label: "Help",
                        placeholder: "Help"
                    },
//                    {
//                        //cellCss: "dhx_layout-cell--bordered",
//                        title: "Type setting",
//                        rows: [
                    {
                        id: "type",
                        type: "select",
                        label: "Type",
                        options: [
                            {
                                value: "String",
                                content: "String"
                            },
                            {
                                value: "Numeric",
                                content: "Numeric"
                            },
                            {
                                value: "Integer",
                                content: "Integer"
                            },
                            {
                                value: "Date",
                                content: "Date"
                            },
                            {
                                value: "Text",
                                content: "Text"
                            },
                            {
                                value: "Extend",
                                content: "Extend Data Type(EDT)"
                            }
                        ]
                    },
                    {
                        id: "objectType",
                        type: "select",
                        label: "EDT type",
                        options: [
                            {
                                value: "dir",
                                content: "Directory"
                            },
                            {
                                value: "doc",
                                content: "Document"
                            },
                            {
                                value: "setting",
                                content: "Setting"
                            },
                            {
                                value: "enum",
                                content: "Enum"
                            }

                            //]
                            //},
//                            {
//                                id: "objectName",
//                                type: "combo",
//                                label: "EDT name",
//
//                            }
                        ]
                    },
//                    {
//                        cols: [
//                            {
//                                type: "button",
//                                value: "Save",
//                                size: "medium",
//                                view: "flat",
//                                color: "primary",
//                                id: "saveField"
//                            },
//                            {
//                                type: "button",
//                                value: "Cancel",
//                                size: "medium",
//                                view: "flat",
//                                color: "primary",
//                                id: "cancelField"
//                            }
//                        ]}

                ];

                var rows2 = [

                    {
                        id: "objectName",
                        type: "combo",
                        label: "EDT name",

                    },

                    {
                        cols: [
                            {
                                type: "button",
                                value: "Save",
                                size: "medium",
                                view: "flat",
                                color: "primary",
                                id: "saveField"
                            },
                            {
                                type: "button",
                                value: "Cancel",
                                size: "medium",
                                view: "flat",
                                color: "primary",
                                id: "cancelField"
                            }
                        ]}

                ];


                var form = new dhx.Form(null, {rows});
                var form2 = new dhx.Form(null, {rows: rows2});
                if (field) {
                    form.setValue(field);
                    if (field.type === 'Extend') {
                        form.setValue({'objectType': field.edtType.objectType});
                        //form.events.fire("Change", ['type', 'Extend']);
                        fillEdtName(field.edtType.objectType, form2, rows2);
                        //alert(JSON.stringify(tree.data.getItem(field.edtType.objectName).value));
                        //form2.setValue({'objectName': tree.data.getItem(field.edtType.objectName).value});
                        form2.setValue({'objectName': field.edtType.objectName});
                    }
                }
                layout.cell('r_props').attach(form);
                layout.cell('r_props2').attach(form2);
                form2.events.on("ButtonClick", function (id_btn, e) {
                    var fields = getFields(list);
                    var newField = {edtType: {}};

                    if (id_btn === "saveField") {
                        if (form.getValue().fieldId && form.getValue().alias) {
                            if (form.getValue().type === "Extend" && !(form.getValue().objectType && form2.getValue().objectName)) {
                                alert("Input all EDT fields!");

                            } else {
                                var objectModel = data;
                                newField.fieldId = form.getValue().fieldId;
                                newField.alias = form.getValue().alias;
                                newField.type = form.getValue().type;
                                newField.helpText = form.getValue().helpText;
                                if (form.getValue().type === "Extend") {
                                    newField.edtType.objectType = form.getValue().objectType;
                                    newField.edtType.objectName = form2.getValue().objectName[0];
                                }

                                if (!field || list.selection.getItem().value.fieldId !== newField.fieldId) {
                                    fields.push(newField);
                                } else {
                                    for (var i = 0; i < fields.length; i++) {
                                        if (fields[i].fieldId === newField.fieldId) {
                                            fields[i] = newField;
                                            break;
                                        }
                                    }
                                }
                                objectModel.fields = fields;
                                //alert(JSON.stringify(newField));
                                //alert(JSON.stringify(objectModel));
                                updateObject(objectModel, null, function (dat) {
                                    form.destructor();
                                    form2.destructor();
                                    loadFielsdList(list, data._id);
                                });

                            }

                        } else {
                            alert("Input id and alias setting's fields!");
                        }
                    }
                    if (id_btn === "cancelField") {
                        // layout.cell('rightbar').detach(form);
                        form.destructor();
                        form2.destructor();
                    }
                });


                form.events.on("Change", function (id, new_value) {

                    var val = null;


                    if (id === 'objectType' || id === 'type') {
                        if (id === 'type' && new_value === 'Extend') {
                            val = form.getValue().objectType;
                        }
                        if (id === 'objectType') {
                            val = new_value;
                        }

                        fillEdtName(val, form2, rows2);
//
//                        var titems = tree.data.getItems(val);
//                        for (var i = 0; i < titems.length; i++) {
//                            var valel = {};
//                            valel.value = titems[i].value;
//                            valel.id = titems[i].id;
//                            vals.push(valel);
//                        }
//
//                        rows2[0].data = vals;
//
//
//
//                        form2.setConfig({rows: rows2});
//
//                        layout.cell('r_props2').attach(form2);

                    }
                });
            }

            function fillEdtName(val, form, rows) {
                var vals = [];
                var titems = tree.data.getItems(val);
                for (var i = 0; i < titems.length; i++) {
                    var valel = {};
                    valel.value = titems[i].value;
                    valel.id = titems[i].id;
                    vals.push(valel);
                }

                rows[0].data = vals;



                form.setConfig({rows});

                layout.cell('r_props2').attach(form);

            }
            function createFieldTab(tabbarObjConf, data) {
                /////--> Fields tab

                var list = new dhx.List(null, {
                    dragMode: "both",
                    dragCopy: true,

                    css: "dhx_widget--bordered baseheight",
                    multiselection: false,
                    template: function (item) {
                        var val = "<strong>" + item.value.fieldId + " </strong>" + JSON.stringify(item.value);
                        return val;
                    }
                });
                var listForm = new dhx.List(null, {
                    dragMode: "both",
                    //height: 500,
                    width: 100,
                    itemHeight: 35,
                    css: "dhx_widget--bordered baseheight",
                    multiselection: false,
                    template: function (item) {
                        var val = "<strong>" + item.value.fieldId + " </strong>";
                        return val;
                    }
                });
                loadFielsdList(list, data._id);
                loadFielsdListForm(listForm, data._id);

                var toolbarFields = createSmallToolBar();
                toolbarFields.data.add({
                    type: "button", value: "Test list form", id: "test", size: "small"
                });
                var layoutObjConfContentFields = new dhx.Layout(null, {
                    rows: [
                        {id: "toolBar"},
                        {cols: [
                                {id: "mainContent", header: "All fields", width: 300, gravity: true},
                                {width: 10, gravity: false},
                                {id: "subContent", header: "List Form's fields", gravity: true}
                            ]}
                    ]
                });
                tabbarObjConf.cell('fields').attach(layoutObjConfContentFields);
                layoutObjConfContentFields.cell('toolBar').attach(toolbarFields);
                layoutObjConfContentFields.cell('mainContent').attach(list);
                layoutObjConfContentFields.cell('subContent').attach(listForm);
                toolbarFields.events.on("Click", function (_id, e) {
                    if (_id === 'add') {
                        //alert('add');

                        editField(data, list);

                    }
                    ;
                    if (_id === 'save') {

                        saveFields(data._id, list);
                        saveFieldsListForm(data._id, listForm);
                        alert('Done!');

                    }
                    if (_id === 'delete') {
                        if (confirm("Delete field?")) {
                            var selid = list.selection.getId();
                            if (selid) {
                                list.data.remove(selid);
                                saveFields(data._id, list);
                            }

                            var selid = listForm.selection.getId();
                            if (selid) {
                                listForm.data.remove(selid);
                                saveFieldsListForm(data._id, listForm);
                            }

                            alert('Done!');
                        } else {

                        }


                    }
                    if (_id === 'test') {
                        var parcel = {};
                        parcel.id = data._id;
                        $.ajax({
                            type: "post",
                            async: false,
                            url: "/build",
                            //headers: {"Access-Control-Allow-Origin": "*"},
                            data: parcel,
                            success: function (data) {
                                alert(JSON.stringify(data.text));


                            }
                        });
                    }

                });
                list.events.on("Click", function (_id, e) {
                    var item = list.data.getItem(_id);
                    editField(data, list, item.value);
                });

                ////<-- Fields tab
            }
//<--ObjectConfigurator//////////////////////////////////////////////////////
//-->TabBar Workplace///////////////////////////////////////////////////////////

            var tabbar = new dhx.Tabbar(null, {
                closeButtons: true,
                views: [
                    {tab: "left", tabCss: "dn"}


                ]

            });



            tabbar.events.on("Close", function (id) {
                tabsWorkplace[id] = false;
                tabsLayouts[id] = null;
                tabbar.setActive(tabbar.setActive(tabbar.getId(0)));

            });
            layout.cell('content').attach(tabbar);
            tabbar.events.on("Change", function (activeId, prevId) {


            });
//<--TabBar Workplace//////////////////////////////////////////////////////////  
        </script>


    </body>
</html>
