<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="suite.js" type="text/javascript"></script>
        <link href="suite.css" rel="stylesheet" type="text/css"/>
        <script src="jquery-3.4.1.min.js" type="text/javascript"></script>
        <link href="index.css" rel="stylesheet" type="text/css"/>
        <script src="global.js" type="text/javascript"></script>
        <!--        <script src="codebase/dhtmlx.js" type="text/javascript"></script>
                <link href="codebase/dhtmlx.css" rel="stylesheet" type="text/css"/>-->
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css">
        <style>
            html, body {height:100%;}
            .dhx_sample-container {
                height: 100%;
            }
            .dn{
                display: none;

            }
            .oa{
                overflow: auto;
            } 
            .st{
                /*font-weight: bold;*/
                background: silver;
            }
            .zi{
                z-index: 1000;
            }
        </style>
        <style>
            .ht .dhx_input {
                height: 25px;
            }
            .baseheight{
                height: 500px;
            }
        </style>
    </head>
    <body onload = "init()">

        <section class="dhx_sample-container">
            <div class="dhx_sample-container__widget" id="layout"></div>

        </section>
        <script>
            function init() {
                loadTree();
            }
            var headerHeight = '120';
            var bottomHeight = '40';
            var workSpaceHeight = $(window).height() - headerHeight - 200;
            var tabsWorkplace = {};
            var tabsLayouts = {};
            var selCurrTreeItem = null;
            var selCurrTreeItemName = null;
            var editObject = null;

//            window.addEventListener('resize', function (event) {
//                workSpaceHeight = $(window).height() - headerHeight - 200;
//                alert(workSpaceHeight);
//                $("['aria-labelledby'='tab-content-main']").height(workSpaceHeight + 50);
//            });
            $(window).resize(function () {
//                workSpaceHeight = $(window).height() - headerHeight - 200;
//
//                $("[aria-labelledby='tab-content-main']").css("flex-basis", workSpaceHeight + 50);
//                $("[aria-labelledby='tab-content-main']").css("height", workSpaceHeight + 50);

            });
            function createSmallToolBar() {
                var toolbar = new dhx.Toolbar(null, {css: "dhx_widget--bordered "});
                var data = [
                    {
                        type: "button",
                        icon: "dxi-plus",
                        //size: "small",
                        value: "",
                        id: 'add',
                        "view": "link",
                        //"color": "secondary",
                        tooltip: "Add item"
                    },

                    {
                        type: "button",
                        icon: "dxi-vault",
                        //size: "small",
                        value: "",
                        id: 'save',
                        "view": "link",
                        //"color": "secondary",
                        tooltip: "Save item"
                    },
                    {
                        type: "button",
                        icon: "dxi-delete",
                        //size: "small",
                        value: "",
                        id: 'delete',
                        "view": "link",
                        //"color": "secondary",
                        tooltip: "Delete item"
                    }
                ];
                toolbar.data.parse(data);
                return toolbar;
            }


            var layout = new dhx.Layout("layout", {
                css: "dhx_layout-cell--bordered",
                rows: [{
                        id: "toolbar",
                        header: "BP 1.0 Configurator",
                        //collapsable: true,
                        css: "dhx_layout-cell--border_bottom",
                        gravity: false,
                        //height: headerHeight + 'px'
                    },
                    {
                        cols: [{
                                id: "sidebar",
                                header: "Menu",
                                collapsable: true,
                                gravity: false,
                                css: "dhx_layout-cell--border_right",
                                resizable: true,
                                width: "220px",
                                rows: [
                                    {
                                        id: "s_toolbar",
                                        height: "90px"
                                    },
                                    {
                                        id: "s_tree"
                                    },
                                ]
                            },
                            {
                                resizable: true,
                                //gravity: false,
                                //rows: [{
                                id: "content",
                                css: "",
                                header: "Workplace",
                                width: "600px"

                                        //}, ]
                            },
                            {
                                id: "rightbar",
                                header: "Settings",
                                collapsable: true,
                                gravity: false,
                                css: "dhx_layout-cell--border_left",
                                resizable: true,
                                width: "300px",
                                rows: [
                                    {
                                        id: "r_props"
                                    },
                                    {
                                        id: "r_props2"
                                    },
                                    {
                                        id: "r_actions"
                                    },
                                ]
                            },
                        ]
                    },
                    {
                        id: "footer",
                        //header: "Footer",
                        //collapsable: true,
                        css: "dhx_layout-cell--border_top",
                        gravity: false,
                        height: bottomHeight + 'px',

                    }
                ]
            });

//-->Main ToolBar////////////////////////////////////////////////////////////////
            var toolbarMain = new dhx.Toolbar(null);
            var data = [
                {
                    type: "button",
                    icon: "dxi-chevron-right",
                    size: "small",
                    value: "",
                    id: 'start'
                },
                {
                    type: "button",
                    icon: "dxi-vault",
                    size: "small",
                    value: "",
                    id: 'save'
                }
            ]
            toolbarMain.data.parse(data);
            layout.cell('toolbar').attach(toolbarMain);
            toolbarMain.events.on("Click", function (id, e) {
                if (id === 'save') {



                }
                if (id === 'start') {

                    $.ajax({
                        type: "post",
                        //async: false,
                        url: "/build",
                        //headers: {"Access-Control-Allow-Origin": "*"},

                        success: function (data) {
                            alert("Build done!");

                        }
                    });
                }
            });

//<--Main ToolBar////////////////////////////////////////////////////////////////
            function showObjectProp(isNew) {

                var titleP = "";
                if (isNew) {
                    titleP = "Create new of " + selCurrTreeItemName;
                } else {
                    titleP = "Edit of " + selCurrTreeItemName;
                }
                //alert(JSON.stringify(selCurrTreeItemName));
                var rows = [
                    {
                        type: "text",
                        //label: "text",
                        //labelInline: true,
                        value: titleP
                    },
                    {
                        id: "name",
                        type: "input",
                        label: "Id",

                        placeholder: "Object id",
                        required: true,
                        validation: "alphanumeric",
                        disabled: !isNew
                    },
                    {
                        id: "alias",
                        type: "input",
                        label: "Alias",

                        placeholder: "Object alias",
                        required: true

                    }
                ];

                var rawsBtn = [
                    {
                        cols: [
                            {
                                type: "button",
                                value: "Save",
                                size: "medium",
                                view: "flat",
                                color: "primary",
                                id: "saveObject"
                            },
                            {
                                type: "button",
                                value: "Cancel",
                                size: "medium",
                                view: "flat",
                                color: "primary",
                                id: "cancel"
                            }
                        ]}
                ];
                var form = new dhx.Form(null, {rows});
                if (!isNew) {

                    getObject(selCurrTreeItem, function (result) {
                        form.setValue({name: selCurrTreeItemName, alias: result.alias});
                        editObject = result;
                    });
                }
                var formBtn = new dhx.Form(null, {rows: rawsBtn});
                layout.cell('r_props').attach(form);
                layout.cell('r_props2').attach(formBtn);
                formBtn.events.on("ButtonClick", function (id, e) {
                    if (id === "saveObject") {
                        if (!form.validate()) {
                            alert("Fill fields correctly!");
                            return;
                        }
                        if (form.getValue().name && form.getValue().alias) {
//                                    if (tree.data.exists(form.getValue().name)){
//                                        alert("Name of object is busy. Change name!");
//                                        return;
//                                    }

                            var objectModel = {};

                            objectModel.name = form.getValue().name;
                            objectModel.alias = form.getValue().alias;
                            if (isNew) {
                                objectModel.objectType = tree.selection.getItem().id;
                                saveObject(objectModel, function (result) {
                                    formBtn.destructor();
                                    form.destructor();
                                    if (result.status === 200) {
                                        alert('Saved!');
                                        loadTree(result.doc._id);
                                    } else {
                                        alert(JSON.stringify(result));
                                    }
                                });

                            } else {
                                objectModel.__v = editObject.__v + 1;
                                objectModel._id = tree.selection.getItem().id;
                                updateObject(objectModel, function (result) {
                                    form.destructor();
                                    formBtn.destructor();
                                    if (result.status === 200) {
                                        alert('Updated!');
                                    } else {
                                        alert(JSON.stringify(result));
                                    }
                                });
                            }
                        } else {
                            alert("Input id and alias of object!");
                        }
                    }
                    if (id === "cancel") {

                        form.clear();
                        form.destructor();
                        formBtn.destructor();
                    }
                });
            }
//-->Sidebar ToolBar/////////////////////////////////////////////////////////////

            var toolbar = createSmallToolBar();
            layout.cell('s_toolbar').attach(toolbar);

            toolbar.events.on("Click", function (id, e) {

                selCurrTreeItem = tree.selection.getId();
                selCurrTreeItemName = tree.selection.getItem().value;


                if (selCurrTreeItem !== undefined) {
                    //alert(JSON.stringify(selCurrTreeItem));


                    if (id === "add") {

                        if (tree.data.getParent(selCurrTreeItem).indexOf("ROOT") === -1) {//second level and more...
                            alert('Select first level!');
                            return;
                        }
                        //alert(JSON.stringify(selCurrTreeItemName));
                        showObjectProp(true);
                    }
                    if (id === "delete") {
                        if (tree.data.getParent(selCurrTreeItem).indexOf("ROOT") === -1) {//second level and more...
                            if (confirm("Delete object?")) {
                                $.ajax({
                                    type: "delete",
                                    //async: false,
                                    url: '/metadata/' + selCurrTreeItem,
                                    //headers: {"Access-Control-Allow-Origin": "*"},

                                    success: function (data) {
                                        if (data.status === 200) {



                                            //tabbar.events.fire("Close",selCurrTreeItem);
                                            $.ajax({
                                                type: "post",
                                                //async: false,
                                                url: "/table/" + selCurrTreeItemName + "/action/drop_table",
                                                //headers: {"Access-Control-Allow-Origin": "*"},

                                                success: function (data) {
                                                    //if (JSON.parse(data).status === 200) {
                                                    alert('Done!');
                                                    tree.data.remove(selCurrTreeItem);
                                                    layout.cell('r_props').attachHTML("<div></did>");
                                                    layout.cell('r_props2').attachHTML("<div></did>");
                                                    tabbar.removeCell(selCurrTreeItem);
//                                                    } else {
//                                                        alert(JSON.parse(data).result);
//                                                    }

                                                }
                                            });


                                        } else {
                                            alert("Object cannot be removed! There are links on it in next objects : " + data.result);
                                        }

                                    }
                                });
                            }
                        }
                    }
                }
            });

//<--Sidebar ToolBar/////////////////////////////////////////////////////////////


//-->Sidebar Tree/////////////////////////////////////////////////////////////
            function loadTree(id) {
                var url = id ? '/metadata/' + id : '/metadata';

                $.ajax({
                    type: "get",
                    //async: false,
                    url: url,
                    //headers: {"Access-Control-Allow-Origin": "*"},

                    success: function (data) {
                        if (id) {//single object
                            if (tree.data.getItem(id)) {//exist
                                //refresh item
                            } else {//new

                                objType = data.objectType;


                                tree.data.add({value: data.name, id: id}, tree.data.getItems(objType).length, objType);
                            }
                        } else {//all tree

                            for (i = 0; i < data.length; i++) {
                                var object = data[i];
                                tree.data.add({value: object.name, id: object._id}, tree.data.getItems(object.objectType).length, object.objectType);
                            }

                        }

                    }
                });
            }
            var tree = new dhx.Tree(null, {keyNavigation: true});
            tree.data.add({
                type: "button",
                icon: "dxi-plus",
                value: "Directories",
                id: 'dir'
            }, 1);
            tree.data.add({
                type: "button",
                icon: "dxi-plus",
                value: "Documents",
                id: 'doc'
            }, 2);
            tree.data.add({
                type: "button",
                icon: "dxi-plus",
                value: "Settings",
                id: 'setting'
            }, 3);
            tree.data.add({
                type: "button",
                icon: "dxi-plus",
                value: "Enums",
                id: 'enum'
            }, 4);
            tree.data.add({
                type: "button",
                icon: "dxi-plus",
                value: "Reports",
                id: 'report'
            }, 5);
            tree.data.add({
                type: "button",
                icon: "dxi-plus",
                value: "Transactions",
                id: 'trx'
            }, 6);

            layout.cell('s_tree').attach(tree);

            tree.events.on("itemClick", function (id, e) {

                selCurrTreeItem = id;
                selCurrTreeItemName = tree.data.getItem(id).value;
                if (tree.data.getParent(id).indexOf("ROOT") == -1) {//second level and more...
                    showObjectProp(false);
                    if (!tabsWorkplace[id]) {//no Tab

                        tabbar.addCell({
                            tab: tree.data.getItem(id).value,
                            //id: tree.data.getItem(id).value
                            id: id

                        }, 0);


                        //tabsWorkplace[tree.data.getItem(id).value] = true;
                        tabsWorkplace[id] = true;
                        //tabbar.setActive(tree.data.getItem(id).value);
                        tabbar.setActive(id);
//                        var c = tabbar.cell(tree.data.getItem(id).value);
//                        c.attach(tree);
                        //alert(tabbar.length);
                        //createObjectConfigurator(tree.data.getItem(id).value);
                        createObjectConfigurator(id);


                    } else {//exist Tab

                        //tabbar.setActive(tree.data.getItem(id).value)
                        tabbar.setActive(id);


                    }
                }
            });

//<--Sidebar Tree/////////////////////////////////////////////////////////////
//--> ObjectConfigurator//////////////////////////////////////////////////////
            function createObjectConfigurator(id) {

                var tableParts = null;
                var forms = null;
                var code = null;

                var layoutObjConf = new dhx.Layout(null, {rows: [{id: "main"}]});




                var tabbarObjConf = new dhx.Tabbar(null, {
                    closeButtons: false,
                    mode: "top",
                    tabWidth: 150,
                    views: [
                        {tab: "Fields", id: "fields"},
                        {tab: "Table Parts", id: "tableParts"},
                        {tab: "Form", id: "forms"},
                        {tab: "Code", id: "code"}
                    ]

                });

                tabsLayouts[id] = layoutObjConf;
                tabbar.cell(id).attach(layoutObjConf);


                layoutObjConf.cell("main").attach(tabbarObjConf);


                $.ajax({
                    type: "get",
                    //async: false,
                    url: '/metadata/' + id,
                    //headers: {"Access-Control-Allow-Origin": "*"},

                    success: function (data) {
                        createFieldTab(tabbarObjConf, data);
                        createFormTab(tabbarObjConf, data);
                        createTablePartsTab(tabbarObjConf, data);

                    }
                });

            }
            function showTablePartProp(objId, tpId, isNew, currTPObj, list) {

                var titleP = "";
                if (isNew) {
                    titleP = "Create new of TableParts"
                } else {
                    titleP = "Edit TablePart";
                }
                //alert(JSON.stringify(selCurrTreeItemName));
                var rows = [
                    {
                        type: "text",
                        //label: "text",
                        //labelInline: true,
                        value: titleP
                    },
                    {
                        id: "name",
                        type: "input",
                        label: "Id",

                        placeholder: "TablePart id",
                        required: true,
                        validation: "alphanumeric",
                        disabled: !isNew
                    },
                    {
                        id: "alias",
                        type: "input",
                        label: "Alias",

                        placeholder: "TablePart alias",
                        required: true

                    }
                ];

                var rawsBtn = [
                    {
                        cols: [
                            {
                                type: "button",
                                value: "Save",
                                size: "medium",
                                view: "flat",
                                color: "primary",
                                id: "saveObject"
                            },
                            {
                                type: "button",
                                value: "Cancel",
                                size: "medium",
                                view: "flat",
                                color: "primary",
                                id: "cancel"
                            }
                        ]}
                ];
                var form = new dhx.Form(null, {rows});
                if (!isNew) {

                    //getObject(objId, function (result) {
                    //alert(JSON.stringify(currTPObj));
                    form.setValue({name: currTPObj.id, alias: currTPObj.value});

                    //});
                }
                var formBtn = new dhx.Form(null, {rows: rawsBtn});
                layout.cell('r_props').attach(form);
                layout.cell('r_props2').attach(formBtn);
                formBtn.events.on("ButtonClick", function (id, e) {
                    if (id === "saveObject") {
                        if (!form.validate()) {
                            alert("Fill fields correctly!");
                            return;
                        }
                        if (form.getValue().name && form.getValue().alias) {
//                                    if (tree.data.exists(form.getValue().name)){
//                                        alert("Name of object is busy. Change name!");
//                                        return;
//                                    }

                            var tablePartObj = {};

                            tablePartObj.id = form.getValue().name;
                            tablePartObj.alias = form.getValue().alias;


                            if (isNew) {

                                getObject(objId, function (obj) {
                                    tablePartObj.fields = [];
                                    tablePartObj.listForm = [];

                                    obj.tableParts.push(tablePartObj);
                                    updateObject(obj, function (result) {
                                        form.destructor();
                                        formBtn.destructor();
                                        if (result.status === 200) {
                                            loadTableParts(list, objId);
                                            alert('Updated!');

                                        } else {
                                            alert(JSON.stringify(result));
                                        }
                                    });
                                });


                            } else {
                                getObject(objId, function (obj) {
                                    for (var i = 0; i < obj.tableParts.length; i++) {
                                        if (obj.tableParts[i].id === tpId) {
                                            //obj.id = form.getValue().name;
                                            obj.tableParts[i].alias = form.getValue().alias;
                                            obj.__v = obj.__v + 1;

                                            updateObject(obj, function (result) {
                                                form.destructor();
                                                formBtn.destructor();
                                                if (result.status === 200) {
                                                    loadTableParts(list, objId);
                                                    alert('Updated!');
                                                } else {
                                                    alert(JSON.stringify(result));
                                                }
                                            });
                                            break;
                                        }
                                    }
                                });




                            }
                        } else {
                            alert("Input id and alias of object!");
                        }
                    }
                    if (id === "cancel") {

                        form.clear();
                        form.destructor();
                        formBtn.destructor();
                    }
                });
            }
            function loadTableParts(list, objId) {
                getObject(objId, function (obj) {
                    var data = [];
                    if (obj.tableParts) {

                        for (var i = 0; i < obj.tableParts.length; i++) {
                            var dataElement = {};
                            dataElement.value = obj.tableParts[i].alias;
                            dataElement.id = obj.tableParts[i].id;
                            data.push(dataElement);
                        }
                        list.data.parse(data);

                    }
                });
            }

            function loadFielsdList(list, objId, tpId) {
                getObject(objId, function (obj) {
                    if (tpId) {
                        var fields = [];
                        for (var i = 0; i < obj.tableParts.length; i++) {
                            if (obj.tableParts[i].id === tpId) {
                                fields = obj.tableParts[i].fields;
                                break;
                            }
                        }

                    } else {
                        var fields = obj.fields;
                    }
                    var data = [];
                    for (var i = 0; i < fields.length; i++) {
                        var dataElement = {};
                        dataElement.value = fields[i];
                        dataElement.id = fields[i].id;
                        data.push(dataElement);
                    }
                    list.data.parse(data);
                });
            }
            function loadFielsdListForm(list, objId, tpId) {
                getObject(objId, function (obj) {
                    if (tpId) {
                        var fields = [];
                        for (var i = 0; i < obj.tableParts.length; i++) {
                            if (obj.tableParts[i].id === tpId) {
                                fields = obj.tableParts[i].listForm;
                                break;
                            }
                        }
                    } else {
                        var fields = obj.listForm;
                    }
                    var data = [];
                    for (var i = 0; i < fields.length; i++) {
                        var dataElement = {};
                        dataElement.value = fields[i];
                        dataElement.id = fields[i].id;
                        data.push(dataElement);
                    }
                    list.data.parse(data);
                });
            }
            function getFields(list) {
                var fields = [];
                var items = list.data.serialize();

                for (var i = 0; i < items.length; i++) {
                    fields.push(items[i].value);
                }
                return fields;
            }
            function saveFields(objId, list, tpId) {

                var fields = getFields(list);


                getObject(objId, function (obj) {
                    if (tpId) {

                        for (var i = 0; i < obj.tableParts.length; i++) {
                            if (obj.tableParts[i].id === tpId) {
                                obj.tableParts[i].fields = fields;
                                break;
                            }
                        }
                    } else {
                        obj.fields = fields;
                    }

                    updateObject(obj, function (result) {

                    });

                });

            }
            function saveFieldsListForm(objId, list, tpId) {
                var fields = getFields(list);

                getObject(objId, function (obj) {
                    if (tpId) {

                        for (var i = 0; i < obj.tableParts.length; i++) {
                            if (obj.tableParts[i].id === tpId) {
                                obj.tableParts[i].listForm = fields;
                                break;
                            }
                        }
                    } else {
                        obj.listForm = fields;
                    }

                    updateObject(obj, function (result) {

                    });

                });

            }
            function editField(data, list, listForm, field, tpId) {

                var rows = [

                    {
                        //cellCss: "st",
                        type: "text",
                        //label: "Create new field",
                        //labelInline: true,
                        value: "Edit field's settings"

                    },
                    {
                        id: "fieldId",
                        type: "input",
                        label: "Id",
                        placeholder: "Id",
                        required: true,
                        validation: "alphanumeric"
                    },
                    {
                        id: "alias",
                        type: "input",
                        label: "Alias",
                        placeholder: "Alias",
                        required: true
                    },
                    {
                        id: "helpText",
                        type: "input",
                        label: "Help",
                        placeholder: "Help"
                    },
//                    {
//                        //cellCss: "dhx_layout-cell--bordered",
//                        title: "Type setting",
//                        rows: [
                    {
                        id: "type",
                        type: "select",
                        label: "Type",
                        options: [
                            {
                                value: "String",
                                content: "String"
                            },
                            {
                                value: "Numeric",
                                content: "Numeric"
                            },
                            {
                                value: "Integer",
                                content: "Integer"
                            },
                            {
                                value: "Date",
                                content: "Date"
                            },
                            {
                                value: "Text",
                                content: "Text"
                            },
                            {
                                value: "Extend",
                                content: "Extend Data Type(EDT)"
                            }
                        ]
                    },
                    {
                        id: "autoIncrement",
                        type: "checkbox",
                        label: "Auto Increment",
                        labelInline: true
                    },
                    {
                        id: "objectType",
                        type: "select",
                        label: "EDT type",
                        options: [
                            {
                                value: "dir",
                                content: "Directory"
                            },
                            {
                                value: "doc",
                                content: "Document"
                            },
                            {
                                value: "setting",
                                content: "Setting"
                            },
                            {
                                value: "enum",
                                content: "Enum"
                            }

                            //]
                            //},
//                            {
//                                id: "objectName",
//                                type: "combo",
//                                label: "EDT name",
//
//                            }
                        ]
                    },
//                    {
//                        cols: [
//                            {
//                                type: "button",
//                                value: "Save",
//                                size: "medium",
//                                view: "flat",
//                                color: "primary",
//                                id: "saveField"
//                            },
//                            {
//                                type: "button",
//                                value: "Cancel",
//                                size: "medium",
//                                view: "flat",
//                                color: "primary",
//                                id: "cancelField"
//                            }
//                        ]}

                ];

                var rows2 = [

                    {
                        id: "objectName",
                        type: "combo",
                        label: "EDT name",

                    },

                    {
                        cols: [
                            {
                                type: "button",
                                value: "Save",
                                size: "medium",
                                view: "flat",
                                color: "primary",
                                id: "saveField"
                            },
                            {
                                type: "button",
                                value: "Cancel",
                                size: "medium",
                                view: "flat",
                                color: "primary",
                                id: "cancelField"
                            }
                        ]}

                ];


                var form = new dhx.Form(null, {rows});
                var form2 = new dhx.Form(null, {rows: rows2});
                if (field) {
                    form.setValue(field);
                    if (field.type === 'Extend') {
                        form.setValue({'objectType': field.edtType.objectType});
                        //form.events.fire("Change", ['type', 'Extend']);
                        fillEdtName(field.edtType.objectType, form2, rows2);
                        //alert(JSON.stringify(tree.data.getItem(field.edtType.objectName).value));
                        //form2.setValue({'objectName': tree.data.getItem(field.edtType.objectName).value});
                        form2.setValue({'objectName': field.edtType.objectId});
                    }
                }
                layout.cell('r_props').attach(form);
                layout.cell('r_props2').attach(form2);
                form2.events.on("ButtonClick", function (id_btn, e) {
                    var fields = getFields(list);
                    var fieldsList = getFields(listForm);
                    var newField = {edtType: {}};

                    if (id_btn === "saveField") {
                        if (form.getValue().fieldId.indexOf('edt_') === 0) {
                            alert("edt_ special prefix! Change field id!");
                            return;
                        }

                        if (!form.validate()) {
                            alert("Fill fields correctly!");
                            return;
                        }
                        if (form.getValue().fieldId && form.getValue().alias) {
                            if (form.getValue().type === "Extend" && !(form.getValue().objectType && form2.getValue().objectName)) {
                                alert("Input all EDT fields!");

                            } else {
                                if (newField.fieldId === '_id') {
                                    alert("_id reserved! _id field will add as default with UID type and primary index...");
                                    return;
                                }
                                var objectModel = data;
                                newField.fieldId = form.getValue().fieldId;
                                newField.alias = form.getValue().alias;
                                newField.type = form.getValue().type;
                                newField.helpText = form.getValue().helpText;
                                if (form.getValue().autoIncrement && newField.type !== "Integer") {
                                    alert("Auto Increment only for Integer type!");
                                    return;
                                }
                                newField.autoIncrement = form.getValue().autoIncrement;
                                if (form.getValue().type === "Extend") {
                                    newField.edtType.objectType = form.getValue().objectType;
                                    newField.edtType.objectId = form2.getValue().objectName[0];
                                    //alert(JSON.stringify(form2.getValue()));
                                    newField.edtType.objectName = tree.data.getItem(form2.getValue().objectName[0]).value;
                                }

                                if (!field || list.selection.getItem().value.fieldId !== newField.fieldId) {
                                    fields.push(newField);
                                } else {
                                    for (var i = 0; i < fields.length; i++) {
                                        if (fields[i].fieldId === newField.fieldId) {
                                            fields[i] = newField;
                                            break;
                                        }
                                    }
                                    for (var i = 0; i < fieldsList.length; i++) {
                                        if (fieldsList[i].fieldId === newField.fieldId) {
                                            fieldsList[i] = newField;
                                            break;
                                        }
                                    }

                                }
                                if (tpId) {
                                    for (var i = 0; i < objectModel.tableParts.length; i++) {
                                        if (objectModel.tableParts[i].id === tpId) {
                                            objectModel.tableParts[i].fields = fields;
                                            objectModel.tableParts[i].listForm = fieldsList;
                                            break;
                                        }
                                    }
                                } else {
                                    objectModel.fields = fields;
                                    objectModel.listForm = fieldsList;
                                }
                                //alert(JSON.stringify(newField));
                                //alert(JSON.stringify(objectModel));
                                updateObject(objectModel, function (result) {
                                    form.destructor();
                                    form2.destructor();
                                    if (tpId) {
                                        loadFielsdList(list, data._id, tpId);
                                    } else {
                                        loadFielsdList(list, data._id);
                                    }
                                    if (result.status === 200) {
                                        alert('Updated!');
                                    } else {
                                        alert(JSON.stringify(result));
                                    }
                                });

                            }

                        } else {
                            alert("Input id and alias setting's fields!");
                        }
                    }
                    if (id_btn === "cancelField") {
                        // layout.cell('rightbar').detach(form);
                        form.destructor();
                        form2.destructor();
                    }
                });


                form.events.on("Change", function (id, new_value) {

                    var val = null;


                    if (id === 'objectType' || id === 'type') {
                        if (id === 'type' && new_value === 'Extend') {
                            val = form.getValue().objectType;
                        }
                        if (id === 'objectType') {
                            val = new_value;
                        }

                        fillEdtName(val, form2, rows2);
//
//                        var titems = tree.data.getItems(val);
//                        for (var i = 0; i < titems.length; i++) {
//                            var valel = {};
//                            valel.value = titems[i].value;
//                            valel.id = titems[i].id;
//                            vals.push(valel);
//                        }
//
//                        rows2[0].data = vals;
//
//
//
//                        form2.setConfig({rows: rows2});
//
//                        layout.cell('r_props2').attach(form2);

                    }
                });
            }

            function fillEdtName(val, form, rows) {
                var vals = [];
                var titems = tree.data.getItems(val);
                for (var i = 0; i < titems.length; i++) {
                    var valel = {};
                    valel.value = titems[i].value;
                    valel.id = titems[i].id;
                    vals.push(valel);
                }

                rows[0].data = vals;



                form.setConfig({rows});

                layout.cell('r_props2').attach(form);

            }
            function uuidv4() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }
            function createValidControlList(id) {
                var controlList = [];
                if (id.indexOf("root_") === 0) {
                    controlList = [];
                    controlList.push({id: "rows", value: "Rows section"});
                    controlList.push({id: "cols", value: "Columns section"});

                }

                if (id.indexOf("cell_") === 0) {
                    controlList = [];
                    controlList.push({id: "html", value: "HTML"});
                    controlList.push({id: "form", value: "Form"});
                    controlList.push({id: "rows", value: "Rows"});
                    controlList.push({id: "cols", value: "Columns"});

                }
                if (id.indexOf("form_") === 0) {
                    controlList = [];
                    //controlList.push({id: "nextCol", value: "Next column"});
                    //controlList.push({id: "groupFields", value: "Group fields"});
                    controlList.push({id: "formrows", value: "From Rows"});
                    controlList.push({id: "formcols", value: "Form Columns"});


                }
                if (id.indexOf("rows_") === 0) {
                    controlList = [];
                    controlList.push({id: "row", value: "Row"});


                }
                if (id.indexOf("cols_") === 0) {
                    controlList = [];
                    controlList.push({id: "col", value: "Column"});


                }
                if (id.indexOf("formrows_") === 0) {
                    controlList = [];
                    //controlList.push({id: "formrow", value: "Form Row"});
                    controlList.push({id: "groupFields", value: "Group fields"});


                }
                if (id.indexOf("formcols_") === 0) {
                    controlList = [];
                    //controlList.push({id: "formcol", value: "Form Column"});
                    controlList.push({id: "groupFields", value: "Group fields"});

                }
                if (id.indexOf("gf_") === 0) {
                    controlList = [];

                    controlList.push({id: "formrows", value: "From Rows"});
                    controlList.push({id: "formcols", value: "Form Columns"});

                }
                return controlList;
            }
            function createFormTab(tabbarObjConf, data) {
                //alert(layout.cell('content'));
                var dragId = null;
                var dragName = null;
                var layoutObjConfContentForms = new dhx.Layout(null, {

                    rows: [
//                        {id: "toolBar"},
                        {cols: [
                                {id: "dataStructure", header: "Fields & Tables", width: 250, gravity: false,
                                    css: "dhx_layout-cell--border_right", resizable: true, height: "700px", collapsable: true,
                                    rows: [
                                        {
                                            id: "toolBarData",
                                            height: "80px",
                                            gravity: false
                                        },
                                        {
                                            id: "contentData",
                                            gravity: false
                                        }
                                    ]

                                },
                                {id: "formStructure", header: "Form Tree", width: 250, gravity: false,
                                    css: "dhx_layout-cell--border_right", resizable: true, height: "700px", collapsable: true,
                                    rows: [
                                        {
                                            id: "toolBar",
                                            height: "80px",
                                            gravity: false
                                        },
                                        {
                                            id: "content",
                                            gravity: false
                                        }
                                    ]

                                },

                                {id: "formEditor", header: "Form Preview", gravity: true, resizable: true,
                                    //css: "dhx_layout-cell--border_left",
                                    height: "700px",

                                }
                            ]}
                    ]
                });

                tabbarObjConf.cell('forms').attach(layoutObjConfContentForms);
                var treeData = new dhx.Tree(null, {keyNavigation: true, dragMode: "source", dragCopy: true});
                treeData.data.add({
                    type: "button",
                    icon: "dxi-plus",
                    value: "Fields",
                    id: "fields",
                    tooltip: "mama"
                }, 1);
                treeData.data.add({
                    type: "button",
                    icon: "dxi-plus",
                    value: "Table parts",
                    id: "tableParts"
                }, 2);



                var treeForm = new dhx.Tree(null, {keyNavigation: true, dragMode: "target", dropBehaviour: "child"});
                treeForm.data.add({
                    type: "button",
                    icon: "dxi-plus",
                    value: "Form Layout",
                    id: "root_" + uuidv4()

                }, 1);

                getObject(data._id, function (cb_data) {
                    if (cb_data.elementForm.length > 0) {
                        var str = JSON.stringify(cb_data.elementForm).split('dollar_').join('$');
                        treeForm.data.parse(str);

                    }
                })

                treeData.events.on("dragstart", function (id, ids) {

                    //target
                    dragId = id;
                    dragName = treeData.data.getItem(id).value;



                });
                treeForm.events.on("beforedrop", function (id, dropPos) {

                    //target
                    //alert(id + " " + dragId);
                    if (id.indexOf('formcols_') !== 0 && id.indexOf('formrows_') !== 0 && dragId.indexOf('fld_') === 0) {
                        alert("Fields can add in formrows or formcols only!");
                        return false;
                    }

                    var state = treeForm.getState();
                    if (state[dragId]) {
                        alert("Field " + dragName + " already exist!");
                        return false;
                    }
                    treeForm.data.add({value: dragName, id: dragId}, treeForm.data.getItems(id).length, id);
                    treeForm.openAll();
                    return false;

                });

                treeForm.events.on("itemClick", function (id, e) {
                    //toolBar.data.getItem('add').items = createValidControlList(id);
                    toolBar.data.remove("add");
                    toolBar.data.add({
                        type: "navItem",
                        icon: "dxi-plus",
                        //size: "small",
                        value: "Add",
                        id: 'add',
                        "view": "link",
                        //"color": "secondary",
                        tooltip: "Add element",
                        items: createValidControlList(id)
                    }, 0);

                });

//                treeForm.data.events.on("AfterAdd", function (newItem) {
//                    console.log("A new item is added");
//                });

                for (var i = 0; i < data.fields.length; i++) {

                    treeData.data.add({value: data.fields[i].fieldId, id: 'fld_' + data.fields[i].fieldId}, treeData.data.getItems("fields").length, "fields");
                }

                var toolBar = createSmallToolBar();
                var toolBarData = createSmallToolBar();
                toolBarData.data.remove("add");
                toolBarData.data.remove("save");
                toolBarData.data.remove("delete");
                toolBarData.data.add({
                    type: "button",
                    icon: "fa fa-retweet",
                    //size: "small",
                    value: "",
                    id: 'refrash',
                    "view": "link",
                    //"color": "secondary",
                    tooltip: "Refrash items"
                }, );
                toolBarData.data.add({
                    type: "button",
                    icon: "dxi-chevron-right",
                    //size: "small",
                    value: "",
                    "view": "link",
                    id: 'start',
                    tooltip: "Render preview"
                });
                toolBar.data.remove("add");
                toolBar.data.add({
                    type: "navItem",
                    icon: "dxi-plus",
                    //size: "small",
                    value: "Add",
                    id: 'add',
                    "view": "link",
                    //"color": "secondary",
                    tooltip: "Add element",
                    items: []
                }, 0);

                layoutObjConfContentForms.cell('toolBar').attach(toolBar);
                layoutObjConfContentForms.cell('toolBarData').attach(toolBarData);
                layoutObjConfContentForms.cell('contentData').attach(treeData);
                layoutObjConfContentForms.cell('content').attach(treeForm);
                toolBar.events.on("Click", function (id, e) {
                    if (id === 'form') {
                        treeForm.data.add({value: "Form", id: 'form_' + uuidv4()}, treeForm.data.getItems(treeForm.selection.getId()).length, treeForm.selection.getId());
                    }
//                    if (id === 'nextCol') {
//                        treeForm.data.add({value: "Next Column", id: 'nc_' + uuidv4()}, treeForm.data.getItems(treeForm.selection.getId()).length, treeForm.selection.getId());
//                    }
                    if (id === 'groupFields') {
                        treeForm.data.add({value: "Field's Group", id: 'gf_' + uuidv4()}, treeForm.data.getItems(treeForm.selection.getId()).length, treeForm.selection.getId());
                    }
                    if (id === 'rows') {
                        treeForm.data.add({value: "Rows", id: 'rows_' + uuidv4()}, treeForm.data.getItems(treeForm.selection.getId()).length, treeForm.selection.getId());
                    }
                    if (id === 'cols') {
                        treeForm.data.add({value: "Columns", id: 'cols_' + uuidv4()}, treeForm.data.getItems(treeForm.selection.getId()).length, treeForm.selection.getId());
                    }
                    if (id === 'row') {
                        treeForm.data.add({value: "Row Cell", id: 'cell_' + uuidv4()}, treeForm.data.getItems(treeForm.selection.getId()).length, treeForm.selection.getId());
                    }
                    if (id === 'col') {
                        treeForm.data.add({value: "Column Cell", id: 'cell_' + uuidv4()}, treeForm.data.getItems(treeForm.selection.getId()).length, treeForm.selection.getId());
                    }
                    if (id === 'html') {
                        treeForm.data.add({value: "HTML block", id: 'html_' + uuidv4()}, treeForm.data.getItems(treeForm.selection.getId()).length, treeForm.selection.getId());
                    }
                    if (id === 'formrows') {
                        treeForm.data.add({value: "Form Rows", id: 'formrows_' + uuidv4()}, treeForm.data.getItems(treeForm.selection.getId()).length, treeForm.selection.getId());
                    }
                    if (id === 'formcols') {
                        treeForm.data.add({value: "Form Columns", id: 'formcols_' + uuidv4()}, treeForm.data.getItems(treeForm.selection.getId()).length, treeForm.selection.getId());
                    }



                    if (id === 'save') {
                        treeForm.selection.remove(treeForm.selection.getId());
                        var structure = treeForm.data.serialize();

                        //treeForm.data.parse(structure);
                        getObject(data._id, function (result) {
                            var str = JSON.stringify(structure);
                            //var newstr = str.replace(/$/g,"dollar_");
                            var newstr = str.split('$').join('dollar_');

                            result.elementForm = JSON.parse(newstr);

                            //alert(JSON.stringify(result.elementForm));
                            updateObject(result, function (cb_data) {
                                alert("Done!");
                            })

                        });


                    }
                    ;
                    if (id === 'delete') {
                        if (treeForm.selection.getId()) {
                            if (confirm("Delete item?")) {
                                treeForm.data.remove(treeForm.selection.getId());
                            }
                        } else {
                            alert("Select item!");
                        }
                    }
                    treeForm.openAll();

                });

                toolBarData.events.on("Click", function (id, e) {
                    if (id === 'start') {
                        $.ajax({
                            type: "get",
                            async: false,
                            url: "/formrender/" + data._id,
                            //headers: {"Access-Control-Allow-Origin": "*"},

                            success: function (result) {
                                //alert(result);
                                //var dhxwindow = new dhx.Window({width: 700, height: 520, title: "Window", resizable: true, closable: true, movable: true});
                                var formhtml = "<div id='" + Object.keys(treeForm.getState())[0] + "' ></div>";
                                //dhxwindow.attachHTML(formhtml);
                                if ($("#" + Object.keys(treeForm.getState())[0]).html() !== undefined) {

                                    $("#" + Object.keys(treeForm.getState())[0]).html("");
                                    layoutObjConfContentForms.cell('formEditor').paint();
                                }

                                if ($("#" + Object.keys(treeForm.getState())[0]).html() === undefined) {
                                    layoutObjConfContentForms.cell('formEditor').attachHTML(formhtml);
                                }


                                let formFunction = new Function(result);


                                setTimeout(() => formFunction(), 1);

                                //-->edt draw
                                setTimeout(() =>
                                    getObject(data._id, function (doc) {
                                        for (var i = 0; i < doc.fields.length; i++) {
                                            var field = doc.fields[i];
                                            if (field.type === "Extend") {
                                                if ($('.dhx_input__wrapper:has("#' + field.fieldId + '")').parents("#" + Object.keys(treeForm.getState())[0]).get(0)) {
                                                    var f = $('.dhx_input__wrapper:has("#' + field.fieldId + '")').get(0);
                                                    var btn = document.createElement("button");
                                                    btn.setAttribute('id', "editButton_name");
                                                    btn.innerHTML = '...';
                                                    btn.style.top = '1px';
                                                    btn.style.zIndex = 0;
                                                    //btn.style.left = (f.offsetWidth - rh - 1) + 'px';
                                                    btn.style.right = 0;
                                                    btn.style.position = 'absolute';
                                                    btn.style.height = btn.style.width = rh + 'px';

                                                    btn.setAttribute('edtData', JSON.stringify(field.edtType));

                                                    btn.onclick = function () {

                                                        //var edtData = field.edtType;
                                                        showListForm(JSON.parse(this.getAttribute('edtData')).objectId, true, function (data) {
                                                            //selectItem[column.id] = data.name;
                                                            //selectItem[column.id.replace("edt_", "")] = data.id;
                                                            //selectItem[column.id].title = 'mama';
                                                            //grid.paint();

                                                            //toolbar.events.fire("Click", ["save"]);
                                                            alert(data.name);

                                                        })
                                                    };
                                                    f.appendChild(btn);
                                                }
                                            }
                                        }
                                    }), 100);
                                //<--edt draw////////




                                //console.log(result);

                            }
                        });
                    }

                });

            }
            function createTableFieldsLayout(data) {
                var list = new dhx.List(null, {
                    dragMode: "both",
                    dragCopy: true,

                    css: "dhx_widget--bordered baseheight",
                    multiselection: false,
                    template: function (item) {
                        var val = "<strong>" + item.value.fieldId + " </strong>";// + JSON.stringify(item.value);
                        return val;
                    }
                });
                var listForm = new dhx.List(null, {
                    dragMode: "both",
                    //height: 500,
                    width: 100,
                    itemHeight: 35,
                    css: "dhx_widget--bordered baseheight",
                    multiselection: false,
                    template: function (item) {
                        var val = "<strong>" + item.value.fieldId + " </strong>";
                        return val;
                    }
                });
                list.events.on("Click", function (id, e) {
                    listForm.selection.remove(listForm.selection.getId());
                });

                listForm.events.on("Click", function (id, e) {
                    list.selection.remove(list.selection.getId());
                });

                loadFielsdList(list, data._id);
                loadFielsdListForm(listForm, data._id);

                var toolbarFields = createSmallToolBar();
                toolbarFields.data.add({
                    type: "button", value: "Test list form", id: "test", size: "small"
                });
                var layoutObjConfContentFields = new dhx.Layout(null, {
                    rows: [
                        {id: "toolBar"},
                        {cols: [
                                {id: "mainContent", header: "All fields", width: 300, gravity: true},
                                {width: 10, gravity: false},
                                {id: "subContent", header: "List Form's fields ( id & name are mandatory )", gravity: true}
                            ]}
                    ]
                });
                layoutObjConfContentFields.cell('toolBar').attach(toolbarFields);
                layoutObjConfContentFields.cell('mainContent').attach(list);
                layoutObjConfContentFields.cell('subContent').attach(listForm);
                toolbarFields.events.on("Click", function (_id, e) {
                    if (_id === 'add') {
                        //alert('add');

                        editField(data, list, listForm);

                    }
                    ;
                    if (_id === 'save') {

                        saveFields(data._id, list);
                        saveFieldsListForm(data._id, listForm);
                        alert('Done!');

                    }
                    if (_id === 'delete') {
                        if (confirm("Delete field?")) {
                            var selid = list.selection.getId();
                            var selItem = list.selection.getItem();
                            //var selid = list.getFocusItem();
                            if (selid) {

                                var arr = [];
                                listForm.data.map(function (item) {
                                    //alert(JSON.stringify(item));
                                    if (item.value.fieldId === selItem.value.fieldId) {
                                        //listForm.data.remove(item.id);
                                        arr.push(item);
                                    }
                                });

                                for (var i = 0; i < arr.length; i++) {
                                    listForm.data.remove(arr[i].id);
                                }
                                list.data.remove(selid);
                                saveFields(data._id, list);
                                saveFieldsListForm(data._id, listForm);
                            }

                            var selid = listForm.selection.getId();
                            //var selid = listForm.getFocusItem();
                            if (selid) {
                                listForm.data.remove(selid);
                                saveFieldsListForm(data._id, listForm);
                            }

                            alert('Done!');
                        } else {

                        }


                    }
                    if (_id === 'test') {
                        var parcel = {};
                        parcel.id = data._id;
                        $.ajax({
                            type: "post",
                            async: false,
                            url: "/build",
                            //headers: {"Access-Control-Allow-Origin": "*"},
                            data: parcel,
                            success: function (data) {
                                alert(JSON.stringify(data.text));


                            }
                        });

                        showListForm(data._id, false, function (data) {
                            alert(JSON.stringify(data));
                        });
                    }

                });
                list.events.on("Click", function (_id, e) {
                    var item = list.data.getItem(_id);
                    editField(data, list, listForm, item.value);
                });

                return layoutObjConfContentFields;

            }
            function createFieldTab(tabbarObjConf, data) {
                /////--> Fields tab

//                var list = new dhx.List(null, {
//                    dragMode: "both",
//                    dragCopy: true,
//
//                    css: "dhx_widget--bordered baseheight",
//                    multiselection: false,
//                    template: function (item) {
//                        var val = "<strong>" + item.value.fieldId + " </strong>" + JSON.stringify(item.value);
//                        return val;
//                    }
//                });
//                var listForm = new dhx.List(null, {
//                    dragMode: "both",
//                    //height: 500,
//                    width: 100,
//                    itemHeight: 35,
//                    css: "dhx_widget--bordered baseheight",
//                    multiselection: false,
//                    template: function (item) {
//                        var val = "<strong>" + item.value.fieldId + " </strong>";
//                        return val;
//                    }
//                });
//                list.events.on("Click", function (id, e) {
//                    listForm.selection.remove(listForm.selection.getId());
//                });
//
//                listForm.events.on("Click", function (id, e) {
//                    list.selection.remove(list.selection.getId());
//                });
//
//                loadFielsdList(list, data._id);
//                loadFielsdListForm(listForm, data._id);
//
//                var toolbarFields = createSmallToolBar();
//                toolbarFields.data.add({
//                    type: "button", value: "Test list form", id: "test", size: "small"
//                });
//                var layoutObjConfContentFields = new dhx.Layout(null, {
//                    rows: [
//                        {id: "toolBar"},
//                        {cols: [
//                                {id: "mainContent", header: "All fields", width: 300, gravity: true},
//                                {width: 10, gravity: false},
//                                {id: "subContent", header: "List Form's fields ( id & name are mandatory )", gravity: true}
//                            ]}
//                    ]
//                });
                //tabbarObjConf.cell('fields').attach(layoutObjConfContentFields);
//                layoutObjConfContentFields.cell('toolBar').attach(toolbarFields);
//                layoutObjConfContentFields.cell('mainContent').attach(list);
//                layoutObjConfContentFields.cell('subContent').attach(listForm);
//                toolbarFields.events.on("Click", function (_id, e) {
//                    if (_id === 'add') {
//                        //alert('add');
//
//                        editField(data, list, listForm);
//
//                    }
//                    ;
//                    if (_id === 'save') {
//
//                        saveFields(data._id, list);
//                        saveFieldsListForm(data._id, listForm);
//                        alert('Done!');
//
//                    }
//                    if (_id === 'delete') {
//                        if (confirm("Delete field?")) {
//                            var selid = list.selection.getId();
//                            var selItem = list.selection.getItem();
//                            //var selid = list.getFocusItem();
//                            if (selid) {
//
//                                var arr = [];
//                                listForm.data.map(function (item) {
//                                    //alert(JSON.stringify(item));
//                                    if (item.value.fieldId === selItem.value.fieldId) {
//                                        //listForm.data.remove(item.id);
//                                        arr.push(item);
//                                    }
//                                });
//
//                                for (var i = 0; i < arr.length; i++) {
//                                    listForm.data.remove(arr[i].id);
//                                }
//                                list.data.remove(selid);
//                                saveFields(data._id, list);
//                                saveFieldsListForm(data._id, listForm);
//                            }
//
//                            var selid = listForm.selection.getId();
//                            //var selid = listForm.getFocusItem();
//                            if (selid) {
//                                listForm.data.remove(selid);
//                                saveFieldsListForm(data._id, listForm);
//                            }
//
//                            alert('Done!');
//                        } else {
//
//                        }
//
//
//                    }
//                    if (_id === 'test') {
//                        var parcel = {};
//                        parcel.id = data._id;
//                        $.ajax({
//                            type: "post",
//                            async: false,
//                            url: "/build",
//                            //headers: {"Access-Control-Allow-Origin": "*"},
//                            data: parcel,
//                            success: function (data) {
//                                alert(JSON.stringify(data.text));
//
//
//                            }
//                        });
//
//                        showListForm(data._id, false, function (data) {
//                            alert(JSON.stringify(data));
//                        });
//                    }
//
//                });
//                list.events.on("Click", function (_id, e) {
//                    var item = list.data.getItem(_id);
//                    editField(data, list, listForm, item.value);
//                });
                tabbarObjConf.cell('fields').attach(createTableFieldsLayout(data));
                ////<-- Fields tab
            }


            function createTablePartsTab(tabbarObjConf, data) {
                
//                buildTableLayout(data._id, false, null, null, function(res){
//                    layout.cell('r_props').attach(res);
//                });
                
                
                var layoutObjConfContentTP = new dhx.Layout(null, {

                    rows: [
//                        {id: "toolBar"},
                        {cols: [
                                {id: "tablePartsCell", header: "Table Parts", width: 250, gravity: false,
                                    css: "dhx_layout-cell--border_right", height: "700px", collapsable: true,
                                    rows: [
                                        {
                                            id: "toolBarTP",
                                            height: "80px",
                                            gravity: false
                                        },
                                        {
                                            id: "contentTP",
                                            gravity: false
                                        }
                                    ]

                                },
                                {
                                    rows: [
                                        {id: 'toolBarTPFields', height: "120px", header: "Table part's fields", },
                                        {
                                            cols: [
                                                {id: "fieldsTP", header: "All fields", gravity: true,
                                                    css: "dhx_layout-cell--border_right", width: 300, height: "700px"
                                                },

                                                {id: "formListFields", header: "Form List Fields", gravity: true,
                                                    //css: "dhx_layout-cell--border_left",
                                                    height: "700px",

                                                }
                                            ]}
                                    ]}
                            ]}
                    ]
                });

                tabbarObjConf.cell('tableParts').attach(layoutObjConfContentTP);
                var list = new dhx.List(null, {
                    dragMode: "both",
                    dragCopy: true,

                    css: "dhx_widget--bordered baseheight",
                    multiselection: false,
                    template: function (item) {
                        var val = "<strong>" + item.value.fieldId + " </strong>";// + JSON.stringify(item.value);
                        return val;
                    }
                });
                var listForm = new dhx.List(null, {
                    dragMode: "both",
                    //height: 500,
                    width: 100,
                    itemHeight: 35,
                    css: "dhx_widget--bordered baseheight",
                    multiselection: false,
                    template: function (item) {
                        var val = "<strong>" + item.value.fieldId + " </strong>";
                        return val;
                    }
                });
                var listTP = new dhx.List(null, {
                    //dragMode: "both",
                    //height: 500,
                    width: 100,
                    itemHeight: 35,
                    css: "dhx_widget--bordered baseheight",
                    multiselection: false,
                    template: function (item) {
                        var val = "<strong>" + item.id + " </strong>";
                        return val;
                    }
                });
                list.events.on("Click", function (id, e) {
                    listForm.selection.remove(listForm.selection.getId());
                    var item = list.data.getItem(id);
                    editField(data, list, listForm, item.value, listTP.selection.getId());
                });

                listForm.events.on("Click", function (id, e) {
                    list.selection.remove(list.selection.getId());
                });
                listTP.events.on("Click", function (id, e) {
                    var tpId = listTP.selection.getId();
                    showTablePartProp(data._id, tpId, false, listTP.selection.getItem(), listTP);
                    loadFielsdList(list, data._id, listTP.selection.getId());
                    loadFielsdListForm(listForm, data._id, listTP.selection.getId());
                });
//                loadFielsdList(list, data._id, tablePartId);
//                loadFielsdListForm(listForm, data._id, tablePartId);
                layoutObjConfContentTP.cell('fieldsTP').attach(list);
                layoutObjConfContentTP.cell('formListFields').attach(listForm);

                loadTableParts(listTP, data._id);
                layoutObjConfContentTP.cell('contentTP').attach(listTP);
                var toolbarTP = createSmallToolBar();
                var toolbarTPFields = createSmallToolBar();
                layoutObjConfContentTP.cell('toolBarTP').attach(toolbarTP);
                layoutObjConfContentTP.cell('toolBarTPFields').attach(toolbarTPFields);
                toolbarTP.events.on("Click", function (_id, e) {
                    if (_id === 'add') {
                        showTablePartProp(data._id, null, true, null, listTP);
                    }
                    if (_id === 'save') {
                        if (!listTP.selection.getId()) {
                            alert("Select Table Part");
                            return;
                        }
                        var parcel = {};
                        parcel.id = data._id;
                        parcel.tpId = listTP.selection.getId();
                        $.ajax({
                            type: "post",
                            async: false,
                            url: "/build",
                            //headers: {"Access-Control-Allow-Origin": "*"},
                            data: parcel,
                            success: function (data) {
                                alert(JSON.stringify(data.text));


                            }
                        });


                    }
                    if (_id === 'delete') {
                        if (!listTP.selection.getId()) {
                            alert("Select Table Part");
                            return;
                        }
                        if (confirm('Delete Table Part?')) {
                            getObject(data._id, function (doc) {
                                var itemID = listTP.selection.getId();
                                //alert(JSON.stringify(doc.tableParts));
                                //alert(itemID);
                                for (var i = 0; i < doc.tableParts.length; i++) {
                                    if (doc.tableParts[i].id === itemID) {
                                        doc.tableParts.splice(i, 1);
                                        listTP.data.remove(itemID);
                                        updateObject(doc, function (res) {
                                            if (res.status === 200) {
                                                alert('Updated!');
                                            } else {
                                                alert(JSON.stringify(result));
                                            }
                                        })
                                        break;
                                    }


                                }
                            });
                        }


                    }
                });

                toolbarTPFields.events.on("Click", function (_id, e) {
                    if (_id === 'add') {
                        if (!listTP.selection.getId()) {
                            alert("Select Table Part");
                            return;
                        }
                        editField(data, list, listForm, null, listTP.selection.getId());
                    }
                    ;
                    if (_id === 'delete') {
                        if (!listTP.selection.getId()) {
                            alert("Select Table Part");
                            return;
                        }
                        if (confirm("Delete field?")) {
                            var selid = list.selection.getId();
                            var selItem = list.selection.getItem();
                            //var selid = list.getFocusItem();
                            if (selid) {

                                var arr = [];
                                listForm.data.map(function (item) {
                                    //alert(JSON.stringify(item));
                                    if (item.value.fieldId === selItem.value.fieldId) {
                                        //listForm.data.remove(item.id);
                                        arr.push(item);
                                    }
                                });

                                for (var i = 0; i < arr.length; i++) {
                                    listForm.data.remove(arr[i].id);
                                }
                                list.data.remove(selid);
                                saveFields(data._id, list, listTP.selection.getId());
                                saveFieldsListForm(data._id, listForm, listTP.selection.getId());
                            }

                            var selid = listForm.selection.getId();
                            //var selid = listForm.getFocusItem();
                            if (selid) {
                                listForm.data.remove(selid);
                                saveFieldsListForm(data._id, listForm, listTP.selection.getId());
                            }

                            alert('Done!');
                        } else {

                        }
                    }
                    ;

                    if (_id === 'save') {
                        if (!listTP.selection.getId()) {
                            alert("Select Table Part");
                            return;
                        }
                        saveFields(data._id, list, listTP.selection.getId());
                        saveFieldsListForm(data._id, listForm, listTP.selection.getId());
                        alert('Done!');

                    }

                });



            }
//<--ObjectConfigurator//////////////////////////////////////////////////////
//-->TabBar Workplace///////////////////////////////////////////////////////////

            var tabbar = new dhx.Tabbar(null, {
                closeButtons: true,
                views: [
                    {tab: "left", tabCss: "dn"}//transparent hide


                ]

            });



            tabbar.events.on("Close", function (id) {
                tabsWorkplace[id] = false;
                tabsLayouts[id] = null;


                tabbar.setActive(tabbar.getId(0))


            });
            layout.cell('content').attach(tabbar);
            tabbar.events.on("Change", function (activeId, prevId) {


            });
//<--TabBar Workplace//////////////////////////////////////////////////////////  

        </script>


    </body>
</html>
